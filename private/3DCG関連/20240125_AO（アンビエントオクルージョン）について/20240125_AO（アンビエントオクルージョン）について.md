# 環境マップについて
 - 3Dオブジェクトやシーンの周囲の環境、光の情報を表現するための特殊なテクスチャ
 - 物体に環境を反映
   - 物体の反射や環境光をシミュレートするのに使用
   - オブジェクトの表面が環境マップによって反映され、周囲の環境に溶け込むようになる
   - 金属などの物体で使われる表現
 - 背景として反映
   - 仮想現実（VR）や360度動画などでシーンの背景や周囲の景観をリアルな背景を表現
## 環境マップの種類
### キューブマップ
 - 6つの平面にマッピングされたテクスチャを使用し、視点の周りの環境を表現
 - 通常、立方体の内部または外部にマッピングされる
 - (今回はこちらについて詳しく見る)

  <img src="environment.PNG" width="200">

### スフィアマップ
 - 球面上にマッピングされたテクスチャを使用し、全方向の環境を表現
 - 球面マップは360度の全方向の景観を表現できる
 - (今回はこちらについて詳しく見る)

  <img src="sphere.PNG" width="200">

## 生成方法
 - スフィアマップは、現実の環境を球状のテクスチャとして撮影することによって生成すえう
 - 通常は360度全方向をキャプチャし、その結果を球状のテクスチャにマッピングする

## キューブマップの仕組み
### 法線ベクトルの算出
 - スフィアマップを使用する際、描画対象の表面上の各点での法線ベクトルを使用する

### スフィア座標の計算
 - 表面上の各点での法線ベクトルが得られたら、その法線ベクトルを使用してスフィア座標を計算する。
 - これは、法線ベクトルを使ってスフィアマップの球体上の位置を特定すること
 - 法線ベクトルは球体上の方向を表すため、それを用いて球体上の位置を計算できます。

  <img src="スフィアマップの仕組み.PNG" width="300">

  <img src="スフィアマップの仕組み_2.PNG" width="300">
  
 - **法線ベクトルから球座標への変換**
   - 球座標系では、ベクトルの方向をθ（極角）とφ（方位角）で表現
   - 法線ベクトル (x, y, z) の球座標 (θ, φ) への変換
     - 極角 θ（theta）: θ = acos(z)
     - 方位角 φ（phi）: φ = atan2(y, x)

 - **球座標からテクスチャ座標への変換**
   - 球座標をテクスチャのUV座標に変換を行う
     - u座標：φ（方位角）
     - v座標：θ（極角）
   - これにより、スフィアマップ上の特定の点が対応する法線ベクトルと関連付けできる

### サンプリング
 - 算出したテクスチャのUV座標を用いて色をサンプリングする


```
in vec3 FragPos;  // フラグメントのワールド座標
in vec3 Normal;   // フラグメントの法線ベクトル

out vec4 FragColor;

uniform sampler2D sphereMap;  // スフィアマップのテクスチャ
uniform vec3 cameraPos;      // カメラの位置

void main()
{
    // カメラからフラグメントまでのベクトル
    vec3 viewDir = normalize(FragPos - cameraPos);

    // ビュー方向と法線ベクトルからスフィアマップ上のテクスチャ座標を計算
    vec3 normSphere = normalize(Normal);
    vec3 reflectDir = reflect(-viewDir, normSphere);
    float theta = acos(reflectDir.y);
    float phi = atan2(reflectDir.z, reflectDir.x);

    // 球座標からテクスチャ座標に変換
    float u = phi / (2.0 * 3.14159265);
    float v = (theta + 3.14159265 * 0.5) / 3.14159265;

    // スフィアマップから色をサンプリング
    vec3 sphereColor = texture(sphereMap, vec2(u, v)).xyz;

    // フラグメントの色をスフィアマップの色で置き換え
    FragColor = vec4(sphereColor, 1.0);
}
```