# Re:Engine（2019年講演）
 - 最新では2023年版の講演が上がってるが以前からの進化が知りたいので古い講義から見ていってる
 - https://www.youtube.com/watch?v=fc3avwM-oTE&t=648s

## カプコンのライブラリ、ゲームエンジンの歴史
 - MTFramework(2005年~)
   - 社内共通のフレームワーク
   - 色々派生していく
 - PantaRhai(2012~2014年)
   - 開発難航、バイオ7が間に合わない
 - Re:Engine(2014年~)
   - PantaRhaiの資産を使いつつ、基本設計からやり直し
 - WorldEngine(2014年~)
   - MTFrameworkを大幅にカスタマイズ
   - モンハンワールド専用のエンジン
     - モンハンというタイトルの規模だからできたこと

	<img src="カプコンの社内フレームワークの歴史.png" width="600">

### MTFrameworkの問題点
 - 大幅な新機能の追加や仕様変更が困難
   - 試作フェーズのタイトルと量産フェーズのタイトルが同時進行している
 - タイトルごとにエンジンの改造がある
   - 互換性がなくなる
   - エンジンの更新作業にめんどくさいマージが必要

## RE:Engineの目的と設計
 - 一つのエンジンで全てのタイトルを開発
   - タイトルごとでの改造禁止
 - イテレーションの改善
   - トライ＆エラーのコストを削減

## RE:Engineの特徴
 - モジュラー構造
 - 下位互換性の維持
 - ツールプロセスの分離
 - リソースアクセスの制約
 - C#スクリプトシステム

## モジュラー構造
 - RE:Engineではプロジェクトごとに必要なモジュールを任意に構成できる

	<img src="モジュラー構造.png" width="600">

### モジュール間の依存関係
 - 3つの依存関係
   - 必須依存（Require）
     - 例えばエフェクトモジュールはレンダリングモジュールが必ず必要
   - いずれかのモジュールが必要（Either）
     - 例えばムービーモジュールは音がなればいいからサウンド系モジュールのいずれかが必要
   - モジュールを最大限使えるが無くても使える（Optional）
     - 物理シミュレーションモジュールはレンダリングモジュールがなくても動くがGPUの機能などを最大限活用できる
 - 依存関係はツールで可視化できる
### モジュール間の結合
 - メインループの定型化
   - モジュールエントリーポイント
     - メインループ内のモジュール登録位置
 - モジュールの登録

	<img src="モジュラー登録.png" width="600">

 - モジュール単体の並列化
 - モジュール間同士の依存関係がないものを並列化

## 下位互換性の維持
### プロジェクト設定による互換
 - 例えばシェーダーモデルも使用するバージョンをプロジェクト単位で設定できる
### モジュールの分離による互換
 - 大幅な仕様変更などはこれで対応
 - 新規でモジュールを新しく作る
 - 既存のモジュールを拡張する
   - モジュールを改修、修正するというよりバリエーションを増やす
### エンジンチームによるタイトル保守
 - 開発終了後のタイトルはエンジンチーム管理になる
 - エンジンチームの権限でアセットを変更可能
 - 開発中のタイトルはタイトルチームに移行期間を設け移行してもらう
 - 過去のタイトルの活用をエンジンのテストケースとして活用
   - オートプレイをさせながらログを取る

## ツールプロセスの分離
### ランタイムとツールをTCP/IP通信で同期
 - ランタイムと分けることで各プラットフォームで実機で確認しやすい
 - ランタイムが落ちてもツールの情報は保持される
### ランタイム構造をシンプルに維持
 - GameObjectの例
   - エンジン上で別名をつけたい
   - レイヤー構造の表示機能
 - ランタイムでの影響は一切ない
### クラウド編集
 - 実機による描画結果を編集するPCに転送して確認できる

## リソースアクセスの制約
### アプリケーション側のコードでリソース読み込みを禁止
 - アプリケーションでは表示非表示、もしくはオブジェクトのアクティブ制御のみ対応
### 同期ロードを廃止
 - 非同期ロードのみ対応
   - 下記のようなコードは非対応
	```
	var tex = Resources.load<TextureResource>("image/〇〇");
	```
 - この制約によりエンジン側でリソースの読み込みを最適化できる
   - 非同期ロードのみ対応なのでリソース自体に依存関係はない
### リソース読み込み順に依存しないロードの最適化（HDD）
 - HDDは処理が遅いのでSEEKなど処理に時間を食ってしまう
 - 非同期ロードのみ対応なので追加されるリソースの読み込みをスタック形式で積むことで一度（最初の）SEEKのみにする
### 並列化による最適化（SSD）
 - SSDは処理が速いのでCPUの方にボトルネックが発生する可能性がある
 - 依存関係がないので容易にロードの最適化ができる

## C#スクリプトシステム
 - ゲームロジックは全てC#で実装
   - タイトル固有のC++コードは存在しない
 - 独自の仮想マシン上で動作（REVM）
 - 独自のガーベシコレクションアルゴリズム（FrameGC）
### ビルド時間
 - RE:Engineで制作した過去タイトル
   - C#ファイル数 3500 ~ 5000
   - コードの行数 300,000 ~ 400,000
   - ビルド時間 7 ~ 8秒

